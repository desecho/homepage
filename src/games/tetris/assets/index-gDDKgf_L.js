(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const f of s.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();const S=10,D=20,w=2,b=D+w,W=1,ne=10,ce=1,ae=1,le=2,fe={1:100,2:300,3:500,4:800},ue=["I","O","T","S","Z","J","L"],p={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[1,1],[1,1]],T:[[0,1,0],[1,1,1],[0,0,0]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]]};function he(e){const t=e.length,r=Array.from({length:t},()=>Array(t).fill(0));for(let i=0;i<t;i+=1)for(let o=0;o<t;o+=1)r[o][t-1-i]=e[i][o];return r}function de(e){const t=[];for(let r=0;r<e.length;r+=1)for(let i=0;i<e.length;i+=1)e[r][i]===1&&t.push([i,r]);return t}function x(e){const t=[];let r=e;for(let i=0;i<4;i+=1)t.push(de(r)),r=he(r);return t}const Se={I:4,O:2,T:3,S:3,Z:3,J:3,L:3},L={I:x(p.I),O:x(p.O),T:x(p.T),S:x(p.S),Z:x(p.Z),J:x(p.J),L:x(p.L)},pe={"0>1":[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],"1>0":[[0,0],[1,0],[1,-1],[0,2],[1,2]],"1>2":[[0,0],[1,0],[1,-1],[0,2],[1,2]],"2>1":[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],"2>3":[[0,0],[1,0],[1,1],[0,-2],[1,-2]],"3>2":[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],"3>0":[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],"0>3":[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},xe={"0>1":[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],"1>0":[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],"1>2":[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],"2>1":[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],"2>3":[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],"3>2":[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],"3>0":[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],"0>3":[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]};function ge(e,t,r){if(e==="O")return[[0,0]];const i=`${t}>${r}`;return e==="I"?xe[i]??[[0,0]]:pe[i]??[[0,0]]}const I=[800,720,630,550,470,380,300,220,130,100,80,80,70,70,60];function ve(e){const t=Math.max(0,Math.min(I.length-1,e-1));return I[t]}const E={I:"#48d8ff",O:"#ffd95e",T:"#c886ff",S:"#61f4a6",Z:"#ff7c7c",J:"#7aa2ff",L:"#ffba6b"},ye=1664525,we=1013904223;function z(e){const t=Math.abs(Math.floor(e))>>>0;return t===0?1:t}function me(e){return e*ye+we>>>0}function be(e,t){const r=me(e);return{value:r%t,seed:r}}function Re(e){let t=z(e);const r=[...ue];for(let i=r.length-1;i>0;i-=1){const{value:o,seed:s}=be(t,i+1);t=s,[r[i],r[o]]=[r[o],r[i]]}return{bag:r,seed:t}}var n=(e=>(e.MoveLeft="move_left",e.MoveRight="move_right",e.SoftDrop="soft_drop",e.HardDrop="hard_drop",e.RotateCW="rotate_cw",e.RotateCCW="rotate_ccw",e.PauseToggle="pause_toggle",e.Restart="restart",e))(n||{});function Pe(){return Array.from({length:b},()=>Array(S).fill(null))}function Me(e){return e.map(t=>[...t])}function Te(e){return{...e,activePiece:{...e.activePiece},nextQueue:[...e.nextQueue],bag:[...e.bag]}}function Ee(e){return!Number.isFinite(e)||e<0?0:Math.floor(e)}function P(e){e.score>e.bestScore&&(e.bestScore=e.score)}function Q(e){if(e.bag.length===0){const t=Re(e.rngSeed);e.bag=t.bag,e.rngSeed=t.seed}return e.bag.shift()}function O(e){for(;e.nextQueue.length<ce;)e.nextQueue.push(Q(e))}function F(e){const t=Se[e];return{type:e,rotation:0,x:Math.floor((S-t)/2),y:0}}function U(e){return L[e.type][e.rotation].map(([t,r])=>({x:e.x+t,y:e.y+r}))}function T(e,t){const r=U(t);for(const i of r)if(i.x<0||i.x>=S||i.y>=b||i.y>=0&&e[i.y][i.x]!==null)return!1;return!0}function X(e=Date.now(),t=0){const r={board:Pe(),activePiece:{type:"I",rotation:0,x:0,y:0},nextQueue:[],bag:[],rngSeed:z(e),score:0,bestScore:Ee(t),level:W,lines:0,isPaused:!1,isGameOver:!1,gravityTimerMs:0},i=Q(r);return r.activePiece=F(i),O(r),T(r.board,r.activePiece)||(r.isGameOver=!0),P(r),r}function _e(e=Date.now(),t=0){return X(e,t)}function m(e,t,r){const i={...e.activePiece,x:e.activePiece.x+t,y:e.activePiece.y+r};return T(e.board,i)?(e.activePiece=i,!0):!1}function k(e,t){const r=e.activePiece.rotation,i=(r+(t?1:3))%4,o=ge(e.activePiece.type,r,i);for(const[s,f]of o){const a={...e.activePiece,rotation:i,x:e.activePiece.x+s,y:e.activePiece.y+f};if(T(e.board,a)){e.activePiece=a;return}}}function Le(e){const t=[];let r=0;for(const o of e)o.every(s=>s!==null)?r+=1:t.push([...o]);return{board:[...Array.from({length:r},()=>Array(S).fill(null)),...t],clearedLines:r}}function Oe(e){O(e);const t=e.nextQueue.shift();if(t===void 0){e.isGameOver=!0;return}O(e),e.activePiece=F(t),T(e.board,e.activePiece)||(e.isGameOver=!0)}function Y(e){const t=Me(e.board);let r=!1;for(const s of U(e.activePiece)){if(s.y<0){r=!0;continue}if(s.y>=b||s.x<0||s.x>=S){r=!0;continue}t[s.y][s.x]=e.activePiece.type}const{board:i,clearedLines:o}=Le(t);if(e.board=i,o>0){const s=fe[o]??0;e.score+=s*e.level,e.lines+=o,e.level=W+Math.floor(e.lines/ne)}return e.gravityTimerMs=0,r?(e.isGameOver=!0,e):(Oe(e),e)}function De(e,t){if(t<=0||e.isGameOver)return e;const r=ve(e.level);for(e.gravityTimerMs+=t;e.gravityTimerMs>=r&&!e.isGameOver;)if(e.gravityTimerMs-=r,!m(e,0,1)){Y(e);break}return e}function Ae(e){let t=0;for(;m(e,0,1);)t+=1;return e.score+=t*le,Y(e)}function Ce(e,t){switch(t){case n.MoveLeft:m(e,-1,0);break;case n.MoveRight:m(e,1,0);break;case n.SoftDrop:m(e,0,1)&&(e.score+=ae);break;case n.RotateCW:k(e,!0);break;case n.RotateCCW:k(e,!1);break}return e}function Ie(e,t,r){if(r.includes(n.Restart))return _e(e.rngSeed+1>>>0,e.bestScore);const i=Te(e);if(r.includes(n.PauseToggle)&&!i.isGameOver&&(i.isPaused=!i.isPaused),i.isPaused||i.isGameOver)return P(i),i;let o=!1;for(const s of r)if(!(s===n.PauseToggle||s===n.Restart)){if(s===n.HardDrop){Ae(i),o=!0;break}if(Ce(i,s),i.isGameOver)return P(i),i}return o||De(i,t),P(i),i}const B=160,N=45,G=45;class ke{constructor(t=window){this.target=t,this.immediateQueue=[],this.leftState={pressed:!1,delayMs:0,repeatMs:0},this.rightState={pressed:!1,delayMs:0,repeatMs:0},this.downState={pressed:!1,repeatMs:0},this.handleKeyDown=r=>{const i=H(r.code);if(i!==null){switch(i){case n.MoveLeft:this.pressHorizontal(this.leftState,i);break;case n.MoveRight:this.pressHorizontal(this.rightState,i);break;case n.SoftDrop:this.pressSoftDrop();break;default:r.repeat||this.immediateQueue.push(i);break}r.preventDefault()}},this.handleKeyUp=r=>{const i=H(r.code);if(i!==null){switch(i){case n.MoveLeft:this.resetHorizontal(this.leftState);break;case n.MoveRight:this.resetHorizontal(this.rightState);break;case n.SoftDrop:this.downState.pressed=!1,this.downState.repeatMs=0;break}r.preventDefault()}},this.handleBlur=()=>{this.resetHorizontal(this.leftState),this.resetHorizontal(this.rightState),this.downState.pressed=!1,this.downState.repeatMs=0},this.target.addEventListener("keydown",this.handleKeyDown),this.target.addEventListener("keyup",this.handleKeyUp),this.target.addEventListener("blur",this.handleBlur)}dispose(){this.target.removeEventListener("keydown",this.handleKeyDown),this.target.removeEventListener("keyup",this.handleKeyUp),this.target.removeEventListener("blur",this.handleBlur)}pollActions(t){const r=this.immediateQueue;return this.immediateQueue=[],this.pushHorizontalRepeats(r,this.leftState,this.rightState.pressed,n.MoveLeft,t),this.pushHorizontalRepeats(r,this.rightState,this.leftState.pressed,n.MoveRight,t),this.pushSoftDropRepeats(r,t),r}pressHorizontal(t,r){t.pressed||(t.pressed=!0,t.delayMs=0,t.repeatMs=0,this.immediateQueue.push(r))}resetHorizontal(t){t.pressed=!1,t.delayMs=0,t.repeatMs=0}pressSoftDrop(){this.downState.pressed||(this.downState.pressed=!0,this.downState.repeatMs=0,this.immediateQueue.push(n.SoftDrop))}pushHorizontalRepeats(t,r,i,o,s){if(!(!r.pressed||i)){if(r.delayMs<B){r.delayMs+=s,r.delayMs>=B&&(t.push(o),r.repeatMs=0);return}for(r.repeatMs+=s;r.repeatMs>=N;)r.repeatMs-=N,t.push(o)}}pushSoftDropRepeats(t,r){if(this.downState.pressed)for(this.downState.repeatMs+=r;this.downState.repeatMs>=G;)this.downState.repeatMs-=G,t.push(n.SoftDrop)}}function H(e){switch(e){case"ArrowLeft":return n.MoveLeft;case"ArrowRight":return n.MoveRight;case"ArrowDown":return n.SoftDrop;case"ArrowUp":case"KeyX":return n.RotateCW;case"KeyZ":return n.RotateCCW;case"Space":return n.HardDrop;case"KeyP":return n.PauseToggle;case"KeyR":return n.Restart;default:return null}}const h=28,d=24,c=20,v=S*h,u=D*h,l=d+v+26,M=150,R=l+M+20,_=c+u+20,Be="#0b1623",Ne="#10273a";class Ge{constructor(t){this.canvas=t;const r=this.canvas.getContext("2d");if(r===null)throw new Error("CanvasRenderingContext2D is unavailable.");this.ctx=r,this.canvas.width=R,this.canvas.height=_}render(t){this.drawBackground(),this.drawBoardFrame(),this.drawPlacedCells(t.board),this.drawActivePiece(t.activePiece),this.drawPanel(t),t.isPaused&&this.drawOverlay("PAUSED"),t.isGameOver&&this.drawOverlay("GAME OVER")}drawBackground(){const t=this.ctx.createLinearGradient(0,0,R,_);t.addColorStop(0,Be),t.addColorStop(1,Ne),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,R,_),this.ctx.fillStyle="rgba(168, 210, 255, 0.08)",this.ctx.beginPath(),this.ctx.arc(78,72,54,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(R-92,96,66,0,Math.PI*2),this.ctx.fill()}drawBoardFrame(){this.ctx.fillStyle="rgba(7, 20, 31, 0.85)",this.ctx.fillRect(d-4,c-4,v+8,u+8),this.ctx.strokeStyle="rgba(188, 224, 255, 0.55)",this.ctx.lineWidth=2,this.ctx.strokeRect(d-4,c-4,v+8,u+8),this.ctx.strokeStyle="rgba(95, 137, 176, 0.24)",this.ctx.lineWidth=1;for(let t=0;t<=S;t+=1){const r=d+t*h;this.ctx.beginPath(),this.ctx.moveTo(r,c),this.ctx.lineTo(r,c+u),this.ctx.stroke()}for(let t=0;t<=D;t+=1){const r=c+t*h;this.ctx.beginPath(),this.ctx.moveTo(d,r),this.ctx.lineTo(d+v,r),this.ctx.stroke()}}drawPlacedCells(t){for(let r=w;r<b;r+=1)for(let i=0;i<S;i+=1){const o=t[r][i];o!==null&&this.drawBoardCell(i,r-w,E[o])}}drawActivePiece(t){const r=L[t.type][t.rotation],i=E[t.type];for(const[o,s]of r){const f=t.x+o,a=t.y+s;a<w||a>=b||this.drawBoardCell(f,a-w,i)}}drawBoardCell(t,r,i){const o=d+t*h,s=c+r*h;this.ctx.fillStyle=i,this.ctx.fillRect(o+1,s+1,h-2,h-2),this.ctx.strokeStyle="rgba(0, 12, 24, 0.55)",this.ctx.lineWidth=1,this.ctx.strokeRect(o+1,s+1,h-2,h-2),this.ctx.fillStyle="rgba(255, 255, 255, 0.16)",this.ctx.fillRect(o+2,s+2,h-8,6)}drawPanel(t){this.ctx.fillStyle="rgba(4, 17, 27, 0.8)",this.ctx.fillRect(l,c,M,u),this.ctx.strokeStyle="rgba(188, 224, 255, 0.45)",this.ctx.lineWidth=1,this.ctx.strokeRect(l,c,M,u),this.ctx.fillStyle="#e9f3ff",this.ctx.font='600 17px "Trebuchet MS", "Gill Sans", sans-serif',this.ctx.fillText("Next",l+14,c+28),this.drawNextPiece(t.nextQueue[0]??null),this.ctx.font='600 15px "Trebuchet MS", "Gill Sans", sans-serif',this.ctx.fillText(`Score: ${t.score}`,l+14,c+172),this.ctx.fillText(`Level: ${t.level}`,l+14,c+202),this.ctx.fillText(`Lines: ${t.lines}`,l+14,c+232),this.ctx.fillText(`Best: ${t.bestScore}`,l+14,c+262),this.ctx.font='500 13px "Trebuchet MS", "Gill Sans", sans-serif',this.ctx.fillStyle="rgba(229, 241, 255, 0.85)",this.ctx.fillText("P: Pause",l+14,c+u-72),this.ctx.fillText("R: Restart",l+14,c+u-52),this.ctx.fillText("Space: Hard Drop",l+14,c+u-32)}drawNextPiece(t){const r=l+14,i=c+40,o=M-28,s=108;if(this.ctx.fillStyle="rgba(7, 22, 35, 0.9)",this.ctx.fillRect(r,i,o,s),this.ctx.strokeStyle="rgba(148, 192, 231, 0.3)",this.ctx.strokeRect(r,i,o,s),t===null)return;const f=L[t][0],a=20,j=Math.max(...f.map(([y])=>y)),ee=Math.max(...f.map(([,y])=>y)),te=(j+1)*a,re=(ee+1)*a,ie=r+(o-te)/2,oe=i+(s-re)/2;this.ctx.fillStyle=E[t];for(const[y,se]of f){const A=ie+y*a,C=oe+se*a;this.ctx.fillRect(A+1,C+1,a-2,a-2),this.ctx.strokeStyle="rgba(0, 15, 30, 0.62)",this.ctx.strokeRect(A+1,C+1,a-2,a-2)}}drawOverlay(t){this.ctx.fillStyle="rgba(4, 10, 16, 0.68)",this.ctx.fillRect(d,c,v,u),this.ctx.fillStyle="#f4f8ff",this.ctx.textAlign="center",this.ctx.font='700 30px "Trebuchet MS", "Gill Sans", sans-serif',this.ctx.fillText(t,d+v/2,c+u/2),this.ctx.textAlign="start"}}const Z="canvas-tetris.best-score";function He(e){if(e===null)return 0;const t=Number.parseInt(e,10);return!Number.isFinite(t)||t<0?0:t}function Ke(){try{return He(window.localStorage.getItem(Z))}catch{return 0}}function We(e){try{window.localStorage.setItem(Z,String(e))}catch{}}const J=document.querySelector("#game-board");if(J===null)throw new Error("Expected a #game-board element in index.html.");const V=new Ge(J),$=new ke(window);let g=X(Date.now(),Ke()),K=performance.now();V.render(g);function q(e){const t=Math.min(100,e-K);K=e;const r=$.pollActions(t),i=g.bestScore;g=Ie(g,t,r),g.bestScore!==i&&We(g.bestScore),V.render(g),window.requestAnimationFrame(q)}window.requestAnimationFrame(q);window.addEventListener("beforeunload",()=>{$.dispose()});
